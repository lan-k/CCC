---
title: "ECMO Stroke Results"
author: "Lan Kelly"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document: 
  reference_docx: rmarkdown-styles-SAP.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, 
error=FALSE, comment='', dpi=400)
options(knitr.kable.NA = '')
options(width=1000) # Wide pages
options(scipen=999) # avoid scientific presentation
# options(fig.width=10)
# options(out.height=10)
# opts_knit$set(global.par = TRUE)
knitr::read_chunk("2_univariate_survival.R")

```

```{r, include = F}
par(mar=c(5,5,5,0)) 
# par(mar=c(3,3,3,0))  #try to change the plotting margins
``` 


```{r get_data}

```

# Risk factors for stroke in COVID-19 patients on Veno-Venous ECMO

This document summarises the analysis of risk factors for stroke in COVID-19 patients treated with veno-venous ECMO. Patients entered the study on the first day of ECMO initiation and those who had a stroke previously were excluded. 

There were `r length(unique(ecmo_patients$pin))` patients in the cohort.

\newpage
## Baseline characteristics

```{r,  results='asis'}
library(arsenal)
library(labelled)
mycontrols  <- tableby.control(test=FALSE, total=T,
                               na.action=na.tableby(T),
                               numeric.stats=c("Nmiss", "median", "q1q3"), #,"min","max"
                               cat.stats=c("Nmiss","countpct"),
                               stats.labels=list(Nmiss="Missing",q1q3='IQR'),
                               digits=1, digits.p=2, digits.pct=1)

ecmo_patients <- ecmo_patients %>%
  mutate(stat = ifelse(as.character(status2) == "Censor",
                          "Alive",as.character(status2)))

vars <- c('age','sex','ethnicity'
          ,'country',"income_group",
          'bmi','apache_ii','sofa','pregnant'
          ,"comorbidity_obesity" ,'comorbidity_immuno','comorbidity_hypertension'
          ,'comorbidity_diabetes',"comorbidity_smoking","comorbidity_chronic_cardiac_disease"
          ,"comorbidity_chronic_neurological_disorder"
          ,'comorbidity_chronic_kidney_disease','comorbidity_chronic_alcohol_abuse_eot'
          ,"comorbidity_malignant_neoplasm",'comorbidity_severe_liver_disease',
          'income_region','era'
          )


tabdata = ecmo_patients %>%
  # mutate(complication_stroke = ifelse(is.na(complication_stroke), 'Missing', 
  #                                     as.character(complication_stroke))) %>%
  filter(stroke_after_ecmo != "No" | is.na(stroke_after_ecmo)) %>%
  select(all_of(vars)) %>%  #stroke_group4
  set_variable_labels(age =  "Age",
                     sex="Sex",
                     ethnicity="Ethnicity",
                     country='Country',
                     income_group = "Economic Region",
                     bmi='BMI',apache_ii='APACHE II',sofa='SOFA',
                     pregnant='Pregnant',
                     comorbidity_obesity = "Comorbid obesity" ,
                     comorbidity_immuno='Comorbid immunosuppression',
                     comorbidity_hypertension='Comorbid hypertension',
                     comorbidity_diabetes='Comorbid diabetes',
                     comorbidity_smoking="Comorbid smoking",
                     comorbidity_chronic_cardiac_disease="Comorbid chronic cardiac disease",
                     comorbidity_chronic_kidney_disease='Comorbid CKD',
                     comorbidity_chronic_alcohol_abuse_eot='Comorbid alcohol abuse',
                     comorbidity_chronic_neurological_disorder = 'Comorbid neurological disorder',
                     comorbidity_malignant_neoplasm="Comorbid malignant neoplasm",
                     comorbidity_severe_liver_disease='Comorbid severe liver disease',
                     era="Pandemic Era",
                     income_region = "Economic region"
                      )




formula <- as.formula(paste0("~", paste0(vars, collapse="+")))

tab1 <- tableby(formula, data=tabdata, control=mycontrols)
summary(tab1, title='Patient Characteristics') 



```

\newpage
## Patients pre ECMO respiratory support characteristics

```{r, results='asis'}

#var_label(tabdata)
##also include AC before, vasoactive before

preecmo_vars <-c("ecmo_highest_fi_o2_6hr_before","ecmo_highest_peep_6hr_before",
         "ecmo_worst_pa_o2_6hr_before","ecmo_worst_pa_co2_6hr_before",
         "ecmo_worst_pa_o2_fi_o2_before",
         "ecmo_prone_before" ,"ecmo_neuromuscolar_blockage_before",
         "ecmo_highest_respiratory_rate_6hr_before", "rr_vent",
         "ac_before", "ecmo_vasoactive_drugs_before")



tabdata <- ecmo_patients %>%
  # mutate(complication_stroke = ifelse(is.na(complication_stroke), 'Missing', 
  #                                     as.character(complication_stroke))) %>%
  filter(stroke_after_ecmo != "No" | is.na(stroke_after_ecmo)) %>%
  select(all_of(preecmo_vars), stat) %>%
  mutate(ac_before = case_when(ac_before == 1 ~ "Yes",
                               ac_before == 0 ~ "No",
                               is.na(ac_before) ~ NA_character_),
         ecmo_highest_fi_o2_6hr_before = ifelse(
           ecmo_highest_fi_o2_6hr_before > 1, ecmo_highest_fi_o2_6hr_before/100,
           ecmo_highest_fi_o2_6hr_before)) %>%
  set_variable_labels(ecmo_highest_fi_o2_6hr_before = "Pre-ECMO FiO2",
                      ecmo_highest_peep_6hr_before = "Pre-ECMO PEEP",
                      ecmo_worst_pa_o2_6hr_before = "Pre-ECMO PaO2",
                      ecmo_worst_pa_co2_6hr_before = "Pre-ECMO PaCO2",
                      ecmo_worst_pa_o2_fi_o2_before = "Pre-ECMO PaO2/FiO2", 
                      ecmo_prone_before = "Pre-ECMO prone positioning",
                      ecmo_neuromuscolar_blockage_before = "Pre-ECMO neuromuscular blockade",
                      ecmo_highest_respiratory_rate_6hr_before = "Highest RR before ECMO (breaths/min)",
                      rr_vent="Respiratory rate at time of ventilation (breaths/min)",
                      ecmo_vasoactive_drugs_before = "Pre-ECMO vasoactive medicine use",
                      ac_before = "Pre-ECMO anticoagulant use",
                      stat = "Stroke or Death")


formula <- as.formula(paste0("stat ~", paste0(preecmo_vars, collapse="+")))

tab2 <- tableby(formula, data=tabdata, control=mycontrols)
summary(tab2, title='Pre-ECMO characteristics')


```

\newpage
## Characteristics of ECMO run

```{r, results='asis'}

#var_label(tabdata)
##also include AC before, vasoactive before

ecmo_vars <-c( 
         'days_sympt_hosp',"days_icu",'days_hosp', 'days_ecmo',
         'days_vent','days_vent_ecmo', 'day', 
         "anticoagulants",
         "outcome")



tabdata <- ecmo_patients %>%
  # mutate(complication_stroke = ifelse(is.na(complication_stroke), 'Missing', 
  #                                     as.character(complication_stroke))) %>%
  filter(stroke_after_ecmo != "No" | is.na(stroke_after_ecmo)) %>%
  select(all_of(ecmo_vars), stat) %>%
  set_variable_labels(anticoagulants = "Anticoagulant Use",
                      days_icu = "Days in ICU",
                      days_ecmo='Length of the ECMO run',
                      days_hosp='Hospital length of stay',
                      days_vent="Days of mechanical ventilation",
                      days_vent_ecmo = "Days from mechanical ventilation to ECMO",
                      days_sympt_hosp="Days from first symptoms to hospitalisation",
                      day='Day put on ECMO',
                      outcome='Outcome',
                      stat = "Stroke or Death")


formula <- as.formula(paste0("stat ~", paste0(ecmo_vars, collapse="+")))

tab3 <- tableby(formula, data=tabdata, control=mycontrols)
summary(tab3, title='ECMO characteristics')


```


\newpage
### DNeurological complications during ECMO

 A patient could have up to two stroke types.

**Cerebral haemorrhage stroke type was created when "Other" or "Undetermined" stroke type was selected and cerebral or intracranial hemorrhage entered into the "other complications" field** 


```{r, results='asis'}

neuro_vars <- c("ICH", "ischaemic","stroke_undetermined")

tabdata <- ecmo_patients %>%
    filter(stroke_after_ecmo != "No" | is.na(stroke_after_ecmo),
           status2 == "Stroke") %>%
    mutate(ICH = case_when(stroke_group2 == "Subarachnoid haemorrhage" ~ 
                                  "Subarachnoid haemorrhage",
                                stroke_group2 == "Intraparenchymal haemorrhage" ~ 
                                  "Intraparenchymal haemorrhage",
                                stroke_group2 == "Cerebral haemorrhage" ~ 
                                  "Cerebral haemorrhage"),
         ischaemic = case_when(stroke_group2 == "Ischemic stroke" ~ 
                                  "Ischemic stroke",
                                stroke_group2 == "Hypoxic ischemic brain injury" ~ 
                                  "Hypoxic ischemic brain injury"),
         stroke_undetermined = case_when(stroke_group2 == "Undetermined type" ~ 
                                  "Undetermined/Other"))  %>%
  # mutate(complication_stroke = ifelse(is.na(complication_stroke), 'Missing', 
  #                                     as.character(complication_stroke))) %>%
   select(all_of(neuro_vars)) %>%
   set_variable_labels(ICH = "Haemorrhagic stroke",
                       ischaemic = "Cerebral ischaemia",
                       stroke_undetermined = "Undetermined type"
                      )



formula <- as.formula(paste0(" ~", paste0(neuro_vars, collapse="+")))

tab4 <- tableby(formula, data=tabdata, control=mycontrols)
summary(tab4, title="Neurological complications")


```


\newpage
### Other complications during ECMO run


```{r, results='asis'}

complic_vars <-c("complication_cardiac_arrest","complication_bacteraemia",
                 "complication_viral_pheumonitis","complication_bacterial_pneumonia",
                 "complication_haemorrhage","complication_anaemia",
                 "complication_acute_renal_failure","complication_rhabdomyolysis",
                 "complication_liver_dysfunction" ,"complication_hyperbilirunemia"
                 )


tabdata <- ecmo_patients %>%
  # mutate(complication_stroke = ifelse(is.na(complication_stroke), 'Missing', 
  #                                     as.character(complication_stroke))) %>%
  filter(stroke_after_ecmo != "No" | is.na(stroke_after_ecmo)) %>%
  select(all_of(complic_vars), stat) %>%
  set_variable_labels(complication_cardiac_arrest = "Cardiac Arrest",
                      complication_bacteraemia = "Bacteraemia",
                      complication_viral_pheumonitis = "Viral pneumonitis",
                      complication_bacterial_pneumonia = "Bacterial Pneumonia",
                      complication_haemorrhage = "Haemorrhage",
                      complication_anaemia = "Anaemia",
                      complication_acute_renal_failure = "Acute renal failure",
                      complication_rhabdomyolysis = "Rhabdomyolysis",
                      complication_liver_dysfunction = "Liver Dysfunction",
                      complication_hyperbilirunemia = "Hyperbilirunemia",
                      stat="Stroke or Death")

formula <- as.formula(paste0("stat ~", paste0(complic_vars, collapse="+")))

tab5 <- tableby(formula, data=tabdata, control=mycontrols)
summary(tab5, title="Other complications during ECMO run")



# ## Create a TableOne object
# tab4 <- CreateTableOne(vars = complic_vars, data = tabdata, factorVars = complic_vars,
#                        includeNA = T,
#                        strata="stroke_group4")
# 
# 
# kableone(print(tab4, test=F, varLabels=T,pDigits=2, missing = F,
#                caption = "Relevant Complications during ECMO run"))

```


\newpage
## Cumulative incidence of ECMO outcomes

The following is a cumulative incidence plot for stroke and death. Most strokes occured within 30 days of initiating ECMO.

```{r ci_curve2}

```

\newpage
# Survival Analysis
Initially, all types of strokes have been combined. If feasible, later analysis may consider haemorrhagic stroke as the outcome and treating cerebral ischaemia as a competing risk.

Univariate analysis initially fitted models for the risk factors separately. Then mutlivariate models were 

Two types of models were used to estimate risk factors for stroke:

- Cause specific for stroke
- Stroke with death as a competing risk.

The risk factors considered were

- age (including an age-squared term)
- sex
- days ventilated pre-ECMO (change from 5 days + squared term)
- ethnicity (white vs all others)
- current smoker
- obesity
- hypertension
- diabetes
- co-morbid cardiac disease
- pre-ECMO use of vasoactive medicines
- single vs double cannula
- P/F ratio (log2-transformed)
- SOFA at ICU admission
- ECMO (during vs after)
- use of anticoagulants during ECMO (time-varying)
- economic region (High vs Middle)
- pandemic era

Squared terms were added to age and days ventilated pre-ECMO to linearise the functional forms, however there was still some residual non-linearity.

Co-morbid neurological conditions and use of anticoagulants before ECMo were not included, because models did not converge due to small numbers (there was only one stroke patient who had either of these risk factors).

\newpage
## Cause specific models for any stroke 

Here the outcome is time to any type of stroke, censoring at death, discharge or 90 days after the initiation of ECMO, whichever comes first. Cox proportional hazards models were used to estimate hazard ratios (HRs) and 95% confidence intervals.

The univariate HR estimates have been combined into a forestplot.


```{r uni_surv_stroke}

```

\newpage
## Competing Risks

Here the outcome is time to any type of stroke, treating death as a competing risk. Patients are censored at discharge or 90 days after the initiation of ECMO, which ever comes first. Fine-Gray models were used to estimate subdistribution hazard ratios (subHR) for the instantaneous risk for stroke.
Fine-Gray model for stroke with death as a competing risk.

The univariate subHR estimates have been combined into a forestplot.

```{r subHR, out.width = "150%"}

```

\newpage
The cause specific and competing risk estimates have been combined into a single forestplot.

```{r cox_CR, out.width = "150%"}



```

\newpage
## Multivariate survival models

In this analysis, all risk factors with less than 50% missing data were included in a multivariate survival mode. Since SOFA and P/F ratio at ECMO initiation had large amounts of missing data, they were excluded from the multivariate analysis.

Question: Although P/F ratio at ECMO initiation and SOFA were excluded, could use of vasoactive drugs before ECMO be considered a marker of disease severity instead?


```{r}

knitr::read_chunk("3_multivariate_survival.R")

```

```{r survival_data}
```

```{r multi_surv}
```

```{r multi_CR}
```

There were `r length(npat)` patients analysed who had `r survFit.p0$nevent` strokes.

\newpage

```{r multi_cox_CR, fig.fullwidth=TRUE}
```

\newpage
# Joint models

Joint models combine survival analysis with longitudinal models for the lab values (biomarkers). A Bayesian approach using the R package 'JMBayes2' was used to fit the joint models. Longitudinal models for the biomarkers were fitted with linear mixed models, allowing different longitudinal trajectories for during or post-ECMO and random intercepts and slopes. Since the analysis is Bayesian, the lower and upper limits represent 95% credible intervals.

For this analysis, the survival model is a Cox proportional hazards model for time to any type of stroke. Later, a competing risks survival model will be investigated.  

Biomarkers included were

- PaO2
- PaCO2
- platelet count

pH and Hb were not included since they caused non-convergence or very wide credible intervals in the joint models. The biomarkers were log2-transformed due to skewness, so the HRs represent a doubling in the biomarker value.

Due to convergence issues, it was not possible to fit models using all the variables in the multivariate survival model. Variables with small numbers were excluded (cannula type, comorbid cardiac disease).
Two types of models were fitted, the first with a reduced number of covariates and the second with a more complete set of covariates.


```{r}
knitr::read_chunk("5_JM_forest.R")
```

```{r jm_hr}
```


\newpage
## Joint Model 1
There were `r summary(jfit_red_ridge)$n` patients analysed with `r summary(jfit_red_ridge)$descrpt[1,1]` longitudinal observations, who had `r sum(summary(jfit_red_ridge)$events)` strokes.

```{r jm_forest_red_un, out.width = "130%"}
```


\newpage
## Joint Model 2
There were `r summary(jointFit1.p1)$n` patients analysed with `r summary(jointFit1.p1)$descrpt[1,1]` longitudinal observations, who had `r sum(summary(jointFit1.p1)$events)` strokes.

```{r jm_forest_un, out.width = "130%"}
```
